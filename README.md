# Magento Project Mess Detector

Some additional commands for the excellent n98-magerun Magento command-line tool that will help you to find out how messed up a Magento instance is :)

So far there's only one single command (`mpmd:corehacks`), but more commands are planned to allow generating reports for code pool overwrites, themes, and some more checks.

Author: [Fabrizio Branca](http://fbrnc.net)

## Installation

There are a few options. You can check out the different options in the [MageRun docs](http://magerun.net/introducting-the-new-n98-magerun-module-system/).

Here's the easiest:

1. Create `~/.n98-magerun/modules/` if it doesn't already exist. (or `/usr/local/share/n98-magerun/modules` if you prefer that)
```
mkdir -p ~/.n98-magerun/modules/
```
2. Clone the mpmd repository in there. 
```
git clone git@github.com:AOEpeople/mpmd.git ~/.n98-magerun/modules/mpmd
```
3. It should be installed.To see that it was installed, check to see if one of the new commands is in there.
```
n98-magerun mpmd:corehacks
```

## Commands

### mpmd:corehacks
```
Usage:
 mpmd:corehacks [--format[="..."]] pathToVanillaCore [htmlReportOutputPath] [skipDirectories]

Arguments:
 pathToVanillaCore     Path to Vanilla Core used for comparison
 htmlReportOutputPath  Path to where the HTML report will be written
 skipDirectories       ':'-separated list of directories that will not be considered (defaults to '.svn:.git')
```

This command requires a vanilla version of Magento (same version and edition! Run `n98-magerun.phar sys:info` for more details) to be present somewhere in the filesystem.
It will then traverse all project files and compare them with the original files. 
This command will also be able to tell the difference between whitespace or code comments changes and real code changes.
It will generate a HTML report that also includes the diffs.

```
$ cd /var/www/magento/htdocs
$ n98-magerun.phar mpmd:corehacks /path/to/vanilla/magento /path/to/report.html
Comparing project files in 'var/www/magento/htdocs' to vanilla Magento code in '/path/to/vanilla/magento'...
+----------------------+-------+

| Type                 | Count |
+----------------------+-------+
| differentFileContent | 2     |
| identicalFiles       | 16049 |
| fileMissingInB       | 1     |
| sameFileButComments  | 0     |
+----------------------+-------+
Generating detailed HTML Report
```

Report preview:

![Image](/docs/img/corehacks.jpg)

### mpmd:codepooloverrides
```
Usage:
 mpmd:codepooloverrides [--format[="..."]] [htmlReportOutputPath] [skipDirectories]

Arguments:
 htmlReportOutputPath  Path to where the HTML report will be written
 skipDirectories       ':'-separated list of directories that will not be considered (defaults to '.svn:.git')
```

This command will compare all code pools with each other and detect files that are overriding each other.
It will show identical files (What's the point of these? But yes, seen projects where this happened), copied files with changes in comments and whitespace only,
and real changes. Of course with diff...
 
Report preview:

![Image](/docs/img/codepooloverride.jpg)




## Dependency Checker

The dependency checker parses one or many files or directories and detects PHP classes that are being "used" there. 

### How does it work?

The dependency checker is a "semi" static code analysis tool. That means it does it's job without actually executing any of the PHP code you're pointing it to, but it does need that module to be installed correctly and it will invoke the Magento framework to resolve classpaths (`catalog/product` -> `Mage_Catalog_Model_Product`)

### Why?

While tool like `pdepend` exists those tools don't know anything about Magento in general, Magento's classpaths and where there are being used. Also sometimes the numbers generated by pdepend are a little overwhelming and after all what are you going to do knowing that you're module has an avarage cyclomatic complexity of x? 

The mpmd:dependencychecker will 
- help you to detect other Magento module the module you're looking at depends on.
- check you module's configuration and let's you know if all actual dependencies are declared correctly and will also know if the module is declaring dependencies that this tool didn't detect (Note: this tool isn't perfect, so please double check before removing any dependencies)
- show you the relations between modules and individual classes
- produce pretty graphs that you can render with [Graphviz](http://www.graphviz.org/)
- help you detect code that requires some refactoring and will help you create cleaner - less dependent - modules in the first place. 

### Parsers

The dependency checker comes with two different parsers (and allows you to add new ones:)

| Parser    | Will process   | How it works                                                                                                                                        |
|-----------|----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| Tokenizer | \*.php, \*.phtml | The `tokenizer` parser will split the PHP file into token and traverses all tokens. Handlers can subscribe to token to detect various class usages. |
| Xpath     | \*.xml          | The `xpath` parser will read the file into a `SimpleXMLElement` object and will pass this to all the subscribed handlers                            |

#### How to add your own parser

Add a new parser via n98-magerun's YAML configuration

```
commands:
  Mpmd\Magento\DependencyCheckCommand:
    parsers:
      - Mpmd\DependencyChecker\Parser\Tokenizer
      - Mpmd\DependencyChecker\Parser\Xpath
      - (... add your parser here ...)
```

All parsers need to implement `Mpmd\DependencyChecker\Parser\ParserInterface`

### Handlers

Every parser comes with a number of handlers. Here's the list of handler that come with the dependency checker:

| Parser    | Handler               | Will process                     | What it does                                                                                         |
|-----------|-----------------------|----------------------------------|------------------------------------------------------------------------------------------------------|
| Tokenizer | Interfaces            | `T_IMPLEMENTS`                   | Finds interfaces: `class A implements B {}`                                                          |
| Tokenizer | WhitespaceString      | `T_NEW`, `T_EXTENDS`, `T_CLASS`  | Finds creating classes with new: `$a = new B();`<br />Finds extended classes: `class A extends B {}` |
| Tokenizer | StaticCalls           | `T_DOUBLE_COLON`                 | Finds static calls: `A::B` and A::B()`                                                               |
| Tokenizer | TypeHints             | `T_FUNCTION`                     | Finds type hints: `function a (B $b) {}`                                                             |
| Tokenizer | MagentoFactoryMethods | `T_STRING` for specific keywords |                                                                                                      |
|           |                       |                                  |                                                                                                      |
|           |                       |                                  |                                                                                                      |


Examples:

```
# Single file:
n98-magerun.phar mpmd:dependencycheck -m app/code/local/My/Module/Model/Test.php

# Full directory:
n98-magerun.phar mpmd:dependencycheck -m app/code/local/My/Module/

# Full modman directory (will also find the files you might have in app/design/):
n98-magerun.phar mpmd:dependencycheck -m .modman/My_Module

# Glob patterns are supported:
n98-magerun.phar mpmd:dependencycheck -m app/code/local/My/*/
n98-magerun.phar mpmd:dependencycheck -m app/code/local/*/*/
n98-magerun.phar mpmd:dependencycheck -m app/code/*/*/*/

# Multiple locations 
n98-magerun.phar mpmd:dependencycheck -m app/code/local/My/Module/ app/code/community/My/OtherModule/ app/design/frontend/mypackage
```
Note: Please specify absolute paths or paths relative to your Magento root directory (not relative to the current directory, which might be different if n98-magerun detected Magento in a different directory (e.g. htdocs/) or you're using `--root-dir=...` to tell n98-magerun where to find your Magento root)

